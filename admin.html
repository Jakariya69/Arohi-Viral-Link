<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mim Premium | Elite Admin Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0e14; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .gradient-text { background: linear-gradient(135deg, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #4c1d95; border-radius: 10px; }
        .input-box { background: rgba(15, 23, 42, 0.8) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; }
        .btn-primary { background: linear-gradient(135deg, #6d28d9, #4f46e5); transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -10px #4f46e5; }
        /* Chat UI Styles */
        .msg-admin { align-self: flex-end; background: #4f46e5; color: white; border-radius: 12px 12px 2px 12px; padding: 6px 10px; font-size: 11px; margin-bottom: 4px; }
        .msg-user { align-self: flex-start; background: #1e293b; color: #cbd5e1; border-radius: 12px 12px 12px 2px; padding: 6px 10px; font-size: 11px; margin-bottom: 4px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10">
            <div>
                <h1 class="text-3xl font-extrabold gradient-text leading-none">ELITE DASHBOARD PRO</h1>
                <p class="text-slate-500 text-[10px] font-bold tracking-[0.2em] uppercase mt-2">Mim Premium - Ultimate Control</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleSettings()" class="glass p-3 rounded-2xl text-violet-400 hover:bg-violet-500/10 transition-all">
                    <i data-lucide="settings"></i>
                </button>
                <div class="glass px-4 py-2 rounded-2xl flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[10px] font-bold text-slate-300 uppercase">System Online</span>
                </div>
            </div>
        </div>

        <div id="settings-panel" class="hidden mb-10 glass p-8 rounded-[2.5rem] border-t border-blue-500/30">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <div class="space-y-6">
                    <div>
                        <h2 class="text-lg font-extrabold mb-4 flex items-center gap-3 text-blue-400 uppercase">
                            <i data-lucide="bell"></i> Announcement
                        </h2>
                        <textarea id="app-notice" placeholder="Enter notice..." class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold min-h-[80px]"></textarea>
                        <div class="flex gap-3 mt-3">
                            <button onclick="updateNotice()" class="flex-1 bg-blue-600 py-3 rounded-xl font-black text-[10px] uppercase">Update Notice</button>
                            <button onclick="deleteNotice()" class="bg-red-500/10 border border-red-500/30 text-red-500 px-6 rounded-xl font-black text-[10px] uppercase">Delete</button>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-white/5">
                        <h2 class="text-lg font-extrabold mb-4 flex items-center gap-3 text-violet-400 uppercase">
                            <i data-lucide="image"></i> Home Thumbnail
                        </h2>
                        <input id="app-home-thumb" type="text" placeholder="Thumbnail URL (Image Link)" class="input-box w-full p-4 rounded-xl outline-none text-sm font-bold">
                        <div class="flex gap-3 mt-3">
                            <button onclick="updateThumb()" class="flex-1 bg-violet-600 py-3 rounded-xl font-black text-[10px] uppercase">Change Image</button>
                            <button onclick="deleteThumb()" class="bg-red-500/10 border border-red-500/30 text-red-500 px-6 rounded-xl font-black text-[10px] uppercase">Delete</button>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-lg font-extrabold mb-4 flex items-center gap-3 text-yellow-400 uppercase">
                        <i data-lucide="message-square"></i> Support Line
                    </h2>
                    <div class="flex flex-col h-[300px] bg-black/40 rounded-[2rem] border border-white/5 overflow-hidden">
                        <div id="chat-user-list" class="flex gap-2 p-3 overflow-x-auto border-b border-white/5 bg-white/5"></div>
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col">
                            <p class="text-[10px] text-slate-500 text-center mt-20 italic font-bold">SELECT A USER ID TO CHAT</p>
                        </div>
                        <div class="p-3 flex gap-2 border-t border-white/5">
                            <input id="admin-msg-input" type="text" placeholder="Type message..." class="input-box flex-1 p-3 rounded-xl outline-none text-xs font-bold">
                            <button onclick="sendReply()" class="bg-yellow-500 text-black px-4 rounded-xl font-black text-[10px] uppercase">Send</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
            <div class="glass p-5 rounded-[2rem]">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1 italic">Total Users</p>
                <h3 id="stat-users" class="text-2xl font-black text-white">0</h3>
            </div>
            <div class="glass p-5 rounded-[2rem]">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1 italic">Pending Pay</p>
                <h3 id="stat-withdraw" class="text-2xl font-black text-pink-500">0</h3>
            </div>
            <div class="glass p-5 rounded-[2rem]">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1 italic">Live Content</p>
                <h3 id="stat-tasks" class="text-2xl font-black text-violet-400">0</h3>
            </div>
            <div class="glass p-5 rounded-[2rem]">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1 italic">Cheaters Log</p>
                <h3 id="stat-cheaters" class="text-2xl font-black text-red-500">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5 space-y-6">
                <div class="glass p-8 rounded-[2.5rem] border-t border-violet-500/30">
                    <h2 class="text-lg font-extrabold mb-6 flex items-center gap-3 italic text-violet-400">
                        <i data-lucide="plus-circle"></i> ADD CONTENT
                    </h2>
                    <div class="space-y-4">
                        <input id="adm-title" type="text" placeholder="Title (e.g. Video 01)" class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold">
                        <input id="adm-url" type="text" placeholder="Link / URL" class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold">
                        <input id="adm-thumb" type="text" placeholder="Thumbnail URL (Image Link)" class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <select id="adm-type" class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold">
                                <option value="tasks">Video Page</option>
                                <option value="social_tasks">Social Task</option>
                            </select>
                            <input id="adm-reward" type="number" value="5" placeholder="Reward" class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold">
                        </div>
                        <button onclick="addContent()" class="w-full btn-primary py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95">Publish to App</button>
                    </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] border-t border-green-500/30">
                    <h2 class="text-lg font-extrabold mb-6 flex items-center gap-3 italic text-green-400">
                        <i data-lucide="user-plus"></i> BALANCE MODIFIER
                    </h2>
                    <div class="space-y-4">
                        <input id="edit-uid" type="text" placeholder="TG-User ID (TG-0000)" class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold">
                        <input id="edit-amt" type="number" placeholder="Set Amount" class="input-box w-full p-4 rounded-2xl outline-none text-sm font-bold">
                        <button onclick="updateBalance()" class="w-full bg-green-600/20 text-green-400 border border-green-500/30 py-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-green-600 hover:text-white transition-all">Apply Balance</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7 space-y-8">
                <div class="glass p-8 rounded-[2.5rem]">
                    <h2 class="text-lg font-extrabold mb-6 flex items-center gap-3 italic text-pink-500">
                        <i data-lucide="wallet"></i> WITHDRAWAL REQUESTS
                    </h2>
                    <div id="adm-withdraw-list" class="space-y-4 max-h-[350px] overflow-y-auto pr-2"></div>
                </div>
                <div class="glass p-8 rounded-[2.5rem]">
                    <h2 class="text-lg font-extrabold mb-6 flex items-center gap-3 italic text-blue-400">
                        <i data-lucide="layout"></i> MANAGE APP CONTENT
                    </h2>
                    <div id="adm-manage-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[350px] overflow-y-auto pr-2"></div>
                </div>
                <div class="glass p-8 rounded-[2.5rem] border border-red-500/10">
                    <h2 class="text-lg font-extrabold mb-6 flex items-center gap-3 italic text-red-500">
                        <i data-lucide="shield-off"></i> CHEATER ALERT LOGS
                    </h2>
                    <div id="adm-cheater-list" class="space-y-3 max-h-[200px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

  <script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCpNJm6i8cH6GNI5j2XQAiUgU7q-97c150", 
        databaseURL: "https://mini-app-link-default-rtdb.firebaseio.com" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let selectedUserId = null;

    // --- SETTINGS LISTENER ---
    db.ref('notice').on('value', s => { if(s.exists()) document.getElementById('app-notice').value = s.val(); });
    db.ref('app_config/home_thumbnail').on('value', s => { if(s.exists()) document.getElementById('app-home-thumb').value = s.val(); });

    function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
    function updateNotice() { db.ref('notice').set(document.getElementById('app-notice').value).then(() => alert("Notice Updated!")); }
    function deleteNotice() { if(confirm("Delete notice?")) db.ref('notice').remove(); }
    
    function updateThumb() { 
        const thumbUrl = document.getElementById('app-home-thumb').value;
        if(!thumbUrl) return alert("Enter URL!");
        db.ref('app_config/home_thumbnail').set(thumbUrl).then(() => alert("Thumbnail Updated!"));
    }
    
    function deleteThumb() { if(confirm("Delete thumbnail?")) db.ref('app_config/home_thumbnail').remove(); }

    // --- CHAT SUPPORT (FIXED) ---
    db.ref('support_chats').on('value', snap => {
        const list = document.getElementById('chat-user-list'); 
        list.innerHTML = "";
        snap.forEach(u => {
            const uid = u.key;
            const btnClass = uid === selectedUserId ? 'bg-yellow-500 text-black' : 'bg-white/10 text-white';
            list.innerHTML += `<button onclick="openChat('${uid}')" class="${btnClass} px-3 py-1.5 rounded-xl text-[10px] font-black uppercase border border-white/5 whitespace-nowrap">${uid}</button>`;
        });
    });

    function openChat(uid) {
        selectedUserId = uid;
        db.ref('support_chats/' + uid).on('value', snap => {
            const box = document.getElementById('chat-messages'); 
            box.innerHTML = "";
            snap.forEach(m => {
                const data = m.val();
                const style = data.sender === 'admin' ? 'msg-admin' : 'msg-user';
                box.innerHTML += `<div class="${style} font-bold">${data.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
        syncManager(); // Refresh list to update selection
    }

    function sendReply() {
        const txt = document.getElementById('admin-msg-input').value;
        if(!txt || !selectedUserId) return;
        db.ref('support_chats/' + selectedUserId).push({ 
            sender: 'admin', 
            text: txt, 
            time: firebase.database.ServerValue.TIMESTAMP 
        });
        document.getElementById('admin-msg-input').value = "";
    }

    // --- CONTENT MANAGEMENT ---
    function addContent() {
        const title = document.getElementById('adm-title').value;
        const url = document.getElementById('adm-url').value;
        const thumb = document.getElementById('adm-thumb').value;
        const type = document.getElementById('adm-type').value;
        const reward = document.getElementById('adm-reward').value;

        if(!title || !url) return alert("Title and URL Required!");
        
        db.ref(type).push({ 
            title: title, 
            name: title, 
            url: url, 
            image: thumb || "https://cdn-icons-png.flaticon.com/512/1179/1179069.png", 
            reward: parseFloat(reward) 
        }).then(() => {
            alert("Content Published!");
            document.getElementById('adm-title').value = "";
            document.getElementById('adm-url').value = "";
        });
    }

        function updateBalance() {
        const uid = document.getElementById('edit-uid').value.trim();
        const amt = document.getElementById('edit-amt').value;
        if(!uid || !amt) return alert("UID and Amount Required!");
        
        const balanceAmt = parseFloat(amt);
        if(isNaN(balanceAmt)) return alert("Please enter a valid number!");

        db.ref('user_activity/' + uid).update({ balance: balanceAmt }).then(() => {
            alert("Balance Updated!");
            document.getElementById('edit-uid').value = "";
            document.getElementById('edit-amt').value = "";
        });
    }

    // --- STATISTICS & WITHDRAW ---
    db.ref('user_activity').on('value', s => document.getElementById('stat-users').innerText = s.numChildren());
    db.ref('cheaters').on('value', s => document.getElementById('stat-cheaters').innerText = s.numChildren());

    db.ref('withdrawals').on('value', snap => {
        const list = document.getElementById('adm-withdraw-list'); 
        list.innerHTML = "";
        document.getElementById('stat-withdraw').innerText = snap.numChildren();
        snap.forEach(child => {
            const w = child.val();
            list.innerHTML += `
            <div class="flex items-center justify-between p-4 bg-slate-900/40 rounded-2xl border border-white/5">
                <div>
                    <p class="text-xs font-black">৳${w.amount} → ${w.number}</p>
                    <p class="text-[8px] text-slate-500 font-bold uppercase select-all">${w.userId}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="confirmPay('${child.key}')" class="bg-green-500/10 text-green-500 px-3 py-1 rounded-lg text-[10px] font-black uppercase border border-green-500/20">Paid</button>
                    <button onclick="rejectPay('${child.key}', '${w.userId}', ${w.amount})" class="bg-red-500/10 text-red-500 px-3 py-1 rounded-lg text-[10px] font-black uppercase border border-red-500/20">Reject</button>
                </div>
            </div>`;
        });
        lucide.createIcons();
    });

    function confirmPay(id) { if(confirm("Confirm this payment as Paid?")) db.ref('withdrawals/'+id).remove(); }

    function rejectPay(id, uid, amount) { 
        if(confirm("Reject this payment? Amount will be refunded to user.")) {
            db.ref('user_activity/' + uid).child('balance').transaction(current => (current || 0) + amount);
            db.ref('withdrawals/' + id).remove();
        }
    }

    // --- MANAGE CONTENT SYNC (উন্নত ভার্সন) ---
    function syncManager() {
        const list = document.getElementById('adm-manage-list');
        
        // সব ডাটা একসাথে শো করার জন্য একটি কমন রেফারেন্স
        const loadContent = () => {
            list.innerHTML = "";
            let total = 0;
            
            // Video Tasks
            db.ref('tasks').once('value', s1 => {
                s1.forEach(c => renderRow(list, c.val().title, 'tasks/'+c.key, 'Video'));
                total += s1.numChildren();
                
                // Social Tasks
                db.ref('social_tasks').once('value', s2 => {
                    s2.forEach(c => renderRow(list, (c.val().name || c.val().title), 'social_tasks/'+c.key, 'Social'));
                    total += s2.numChildren();
                    document.getElementById('stat-tasks').innerText = total;
                });
            });
        };

        // যখনই কোনো ডাটা চেঞ্জ হবে, রিলোড হবে
        db.ref('tasks').on('value', loadContent);
        db.ref('social_tasks').on('value', loadContent);
    }

    function renderRow(container, title, path, tag) {
        container.innerHTML += `
        <div class="p-4 bg-slate-900/30 rounded-2xl border border-white/5 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <span class="text-[7px] text-violet-400 font-bold uppercase px-2 py-0.5 bg-violet-400/10 rounded-full">${tag}</span>
                <div class="flex gap-3">
                    <button onclick="editContent('${path}')" class="text-blue-400">
                        <i data-lucide="edit-3" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="removeItem('${path}')" class="text-red-400">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            </div>
            <p class="text-[10px] font-bold truncate">${title}</p>
        </div>`;
        lucide.createIcons();
    }

    function editContent(path) {
        db.ref(path).once('value').then(snap => {
            const data = snap.val();
            if (!data) return alert("ডাটা পাওয়া যায়নি!");
            const oldTitle = data.title || data.name || "";
            const oldUrl = data.url || ""; 

            const newTitle = prompt("Edit Title:", oldTitle);
            if (newTitle !== null) {
                const newUrl = prompt("Edit Link/URL:", oldUrl);
                if (newUrl !== null) {
                    db.ref(path).update({ 
                        title: newTitle, 
                        name: newTitle, 
                        url: newUrl 
                    }).then(() => alert("সফলভাবে আপডেট হয়েছে!"));
                }
            }
        });
    }

    db.ref('cheaters').on('value', snap => {
        const list = document.getElementById('adm-cheater-list'); list.innerHTML = "";
        snap.forEach(c => {
            list.innerHTML += `<div class="p-3 bg-red-500/5 rounded-xl border border-red-500/10 text-[9px] flex justify-between items-center"><span class="truncate">${c.val().name || 'Unknown'} | ${c.key}</span><button onclick="removeItem('cheaters/${c.key}')" class="text-red-400 font-bold uppercase text-[8px] ml-2">Clear</button></div>`;
        });
    });

    function removeItem(path) { if(confirm("Confirm Delete?")) db.ref(path).remove(); }

    syncManager(); 
    lucide.createIcons();
</script>
</body>
</html>
